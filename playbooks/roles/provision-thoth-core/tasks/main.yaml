---
  - name: login to OpenShift using provided token
    command: "oc login --insecure-skip-tls-verify=true --token {{ token }} {{ openshift_master_url }}"

  - name: "create Thoth Tiers"
    command: "oc new-project {{ item }}"
    ignore_errors: true
    with_items:
      - "{{ THOTH_BACKEND_NAMESPACE  }}"
      - "{{ THOTH_MIDDLEEND_NAMESPACE }}"
      - "{{ THOTH_FRONTEND_NAMESPACE }}"

  - name: "make sure to use project {{ THOTH_BACKEND_NAMESPACE }}"
    command: "oc project {{ THOTH_BACKEND_NAMESPACE }}"
    register: project_exists
    ignore_errors: true

  - name: create Thoth Core template
    command: oc create --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/template.yaml
    register: template_rc
    ignore_errors: true

  - name: replace existing Thoth Core template
    command: oc replace --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/template.yaml
    when: template_rc is failed

  - name: create Thoth User API templates
    command: "oc create --namespace {{ THOTH_BACKEND_NAMESPACE }} --filename {{ item }}"
    register: template_rc
    ignore_errors: true
    with_items:
      - "https://raw.githubusercontent.com/thoth-station/user-api/master/openshift/deployment-template.yaml"
      - "https://raw.githubusercontent.com/thoth-station/user-api/master/openshift/buildConfig-template.yaml"

  - name: create Thoth Result API templates
    command: "oc create --namespace {{ THOTH_BACKEND_NAMESPACE }} --filename {{ item }}"
    register: template_rc
    ignore_errors: true
    with_items:
      - "https://raw.githubusercontent.com/thoth-station/result-api/master/openshift/deployment-template.yaml"
      - "https://raw.githubusercontent.com/thoth-station/result-api/master/openshift/buildConfig-template.yaml"

  - name: create Thoth Core secrets template
    command: oc create --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/secret-template.yaml
    register: template_rc
    ignore_errors: true

  - name: replace existing Thoth Core secrets template
    command: oc replace --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/secret-template.yaml
    when: template_rc is failed

  - name: create Thoth Core configmap template
    command: oc create --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/configmap-template.yaml
    register: template_rc
    ignore_errors: true

  - name: replace existing Thoth Core configmap template
    command: oc replace --namespace "{{ THOTH_BACKEND_NAMESPACE  }}" --filename ../openshift/configmap-template.yaml
    when: template_rc is failed

  - name: create required secrets
    command: oc new-app --namespace {{ item }} --template="{{ THOTH_BACKEND_NAMESPACE  }}/thoth-core-secret" \
        --namespace "{{ item }}" \
        -p THOTH_SECRET="{{ THOTH_SECRET }}" \
        -p THOTH_CEPH_KEY_ID="{{ THOTH_CEPH_KEY_ID }}" \
        -p THOTH_CEPH_SECRET_KEY="{{ THOTH_CEPH_SECRET_KEY }}"
    ignore_errors: true
    with_items:
      - "{{ THOTH_BACKEND_NAMESPACE  }}"
      - "{{ THOTH_MIDDLEEND_NAMESPACE }}"
      - "{{ THOTH_FRONTEND_NAMESPACE }}"

  - name: create required configmaps
    command: oc new-app --namespace {{ item }} --template="{{ THOTH_BACKEND_NAMESPACE  }}/thoth-core-configmap" \
        --namespace "{{ item }}" \
        -p THOTH_DEPLOYMENT_NAME="{{ THOTH_DEPLOYMENT_NAME }}" \
        -p THOTH_FRONTEND_NAMESPACE="{{ THOTH_FRONTEND_NAMESPACE }}" \
        -p THOTH_MIDDLEEND_NAMESPACE="{{ THOTH_MIDDLEEND_NAMESPACE }}" \
        -p THOTH_BACKEND_NAMESPACE="{{ THOTH_BACKEND_NAMESPACE }}" \
        -p THOTH_CEPH_HOST="{{ THOTH_CEPH_HOST }}" \
        -p THOTH_CEPH_BUCKET="{{ THOTH_CEPH_BUCKET }}"
    ignore_errors: true
    with_items:
      - "{{ THOTH_BACKEND_NAMESPACE  }}"
      - "{{ THOTH_MIDDLEEND_NAMESPACE }}"
      - "{{ THOTH_FRONTEND_NAMESPACE }}"

  - name: deploy Thoth Core
    command: oc new-app --template="{{ THOTH_BACKEND_NAMESPACE  }}/thoth-core" \
        -p THOTH_DEPLOYMENT_NAME="{{ THOTH_DEPLOYMENT_NAME }}" \
        -p THOTH_FRONTEND_NAMESPACE="{{ THOTH_FRONTEND_NAMESPACE }}" \
        -p THOTH_MIDDLEEND_NAMESPACE="{{ THOTH_MIDDLEEND_NAMESPACE }}" \
        -p THOTH_BACKEND_NAMESPACE="{{ THOTH_BACKEND_NAMESPACE }}"

  - name: deploy Thoth Results API
    command: oc new-app --template="{{ THOTH_BACKEND_NAMESPACE  }}/thoth-result-api-deployment" \
        -p THOTH_MIDDLETIER_NAMESPACE="{{ THOTH_MIDDLEEND_NAMESPACE }}"

  - name: create JanusGraph Database Template
    command: oc create --namespace "{{ THOTH_MIDDLEEND_NAMESPACE }}" \
        --filename https://raw.githubusercontent.com/goern/janusgraph-openshift/master/template.yaml
    register: janusgraph_template_rc
    ignore_errors: true

  - name: replace existing JanusGraph template
    command: oc replace --namespace "{{ THOTH_MIDDLEEND_NAMESPACE }}" \
        --filename https://raw.githubusercontent.com/goern/janusgraph-openshift/master/template.yaml
    when: template_rc is failed
    
  - name: deploy JanusGraph Database
    command: oc new-app --namespace "{{ THOTH_MIDDLEEND_NAMESPACE }}" \
        --template=janusgraph

